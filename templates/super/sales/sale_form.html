{% extends 'components/base.html' %}
{% load static %}
{% block title %}{% if form.instance.pk %}Editar Venta{% else %}Registrar Venta{% endif %}{% endblock %}
{% block content %}
<div class="container mx-auto py-8 px-16">
    <h1 class="text-3xl font-bold mb-6">{% if form.instance.pk %}Editar Venta{% else %}Registrar Venta{% endif %}</h1>

    <form method="post" id="saleForm" class="space-y-6" 
          data-initial-details="{% if initial_details %}{{ initial_details|safe }}{% else %}[]{% endif %}" 
          data-initial-totals="{% if initial_totals %}{{ initial_totals|safe }}{% else %}{{ '{}' }}{% endif %}">
        {% csrf_token %}

        <!-- Campos principales de la venta -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">Cliente</label>
                {{ form.customer }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Vendedor</label>
                {{ form.seller }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Forma de Pago</label>
                {{ form.payment }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Fecha</label>
                {{ form.sale_date }}
            </div>
        </div>

        <!-- Detalle de la venta -->
        <div class="bg-gray-50 p-4 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Detalle de Venta</h2>
            <table id="sale-details" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Producto</th>
                        <th class="py-2 px-4 border-b">Cantidad</th>
                        <th class="py-2 px-4 border-b">Precio</th>
                        <th class="py-2 px-4 border-b">Subtotal</th>
                        <th class="py-2 px-4 border-b">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button type="button" id="add-product" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Agregar Producto</button>
        </div>

        <!-- Template oculto para las filas -->
        <template id="detail-row-template">
            <tr class="detail-row">
                <td class="py-2 px-4 border-b">
                    <select class="product-select w-full rounded-md border-gray-300"></select>
                </td>
                <td class="py-2 px-4 border-b">
                    <input type="number" class="quantity-input w-full rounded-md border-gray-300" min="1" value="1">
                </td>
                <td class="py-2 px-4 border-b">
                    <input type="number" class="price-input w-full rounded-md border-gray-300" readonly>
                </td>
                <td class="py-2 px-4 border-b">
                    <input type="number" class="subtotal-input w-full rounded-md border-gray-300" readonly>
                </td>
                <td class="py-2 px-4 border-b">
                    <button type="button" class="delete-row bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Eliminar</button>
                </td>
            </tr>
        </template>

        <!-- Modal de productos -->
        <div id="productModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg w-3/4 max-h-[80vh] overflow-y-auto">
                <h3 class="text-lg font-semibold mb-2">Seleccionar Producto</h3>
                <input type="text" id="productSearch" class="w-full p-2 mb-2 border rounded" placeholder="Buscar producto...">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b">Nombre</th>
                            <th class="py-2 px-4 border-b">Precio</th>
                            <th class="py-2 px-4 border-b">Stock</th>
                            <th class="py-2 px-4 border-b">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
                <button id="closeModal" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cerrar</button>
            </div>
        </div>

        <!-- Totales -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">Subtotal</label>
                <input type="number" name="subtotal" readonly class="w-full rounded-md border-gray-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">IVA (15%)</label>
                <input type="number" name="iva" readonly class="w-full rounded-md border-gray-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Descuento</label>
                <input type="number" name="discount" value="0.00" class="w-full rounded-md border-gray-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Total</label>
                <input type="number" name="total" readonly class="w-full rounded-md border-gray-300">
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex justify-end space-x-4">
            <a href={{ back_url }} class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</a>
            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">{{ grabar }}</button>
        </div>
    </form>
</div>
<script src="{% static 'js/sale.js' %}"></script>
{% endblock %}